ZONE=$(gcloud compute project-info describe --format="value(commonInstanceMetadata.items[google-compute-default-zone])")
if [ -z "$ZONE" ]; then
  read -p "Default zone not found. Enter zone (e.g. us-east1-d): " ZONE
fi
REGION="${ZONE%-*}"
PROJECT_ID=$(gcloud config get-value project)

echo "Using Zone: $ZONE"
echo "Using Region: $REGION"
echo

# Create web VMs
echo "Creating web1, web2, web3..."
for i in 1 2 3; do
  echo "Creating web$i ..."
  gcloud compute instances create web$i \
    --zone="$ZONE" \
    --machine-type=e2-small \
    --tags=network-lb-tag \
    --network=default \
    --image-family=debian-12 \
    --image-project=debian-cloud \
    --metadata=startup-script="#!/bin/bash
apt-get update
apt-get install apache2 -y
service apache2 restart
echo \"<h3>Web Server: web$i</h3>\" > /var/www/html/index.html"
done

echo "Web servers created."

# Firewall for network LB
echo "Creating firewall rule www-firewall-network-lb..."
gcloud compute firewall-rules create www-firewall-network-lb \
  --allow tcp:80 \
  --network=default \
  --target-tags=network-lb-tag
echo "Firewall rule created."

# Network Load Balancer (regional)
echo "Configuring Network Load Balancer..."
gcloud compute addresses create network-lb-ip-1 --region="$REGION"
gcloud compute http-health-checks create basic-check
gcloud compute target-pools create www-pool --region="$REGION" --http-health-check basic-check
gcloud compute target-pools add-instances www-pool --instances=web1,web2,web3 --zone="$ZONE"
gcloud compute forwarding-rules create www-rule --region="$REGION" --ports=80 --address=network-lb-ip-1 --target-pool=www-pool

NLB_IP=$(gcloud compute forwarding-rules describe www-rule --region="$REGION" --format="get(IPAddress)")
echo "Network Load Balancer created. IP: $NLB_IP"

# HTTP Global Load Balancer
echo "Setting up HTTP Load Balancer..."

gcloud compute instance-templates create lb-backend-template \
  --machine-type=e2-medium \
  --tags=allow-health-check \
  --image-family=debian-12 \
  --image-project=debian-cloud \
  --metadata=startup-script="#!/bin/bash
apt-get update
apt-get install apache2 -y
vm=\$(hostname)
echo \"Page served from: \$vm\" > /var/www/html/index.html
systemctl restart apache2"

gcloud compute instance-groups managed create lb-backend-group \
  --template=lb-backend-template \
  --size=2 \
  --zone="$ZONE"

gcloud compute firewall-rules create fw-allow-health-check \
  --network=default \
  --action=allow \
  --direction=ingress \
  --source-ranges=130.211.0.0/22,35.191.0.0/16 \
  --target-tags=allow-health-check \
  --rules=tcp:80

gcloud compute addresses create lb-ipv4-1 --ip-version=IPV4 --global
LB_IP=$(gcloud compute addresses describe lb-ipv4-1 --global --format="get(address)")

gcloud compute health-checks create http http-basic-check --port=80

gcloud compute backend-services create web-backend-service \
  --protocol=HTTP \
  --port-name=http \
  --health-checks=http-basic-check \
  --global

gcloud compute backend-services add-backend web-backend-service \
  --instance-group=lb-backend-group \
  --instance-group-zone="$ZONE" \
  --global

gcloud compute url-maps create web-map-http --default-service web-backend-service
gcloud compute target-http-proxies create http-lb-proxy --url-map=web-map-http
gcloud compute forwarding-rules create http-content-rule --address=lb-ipv4-1 --global --target-http-proxy=http-lb-proxy --ports=80

echo "HTTP Load Balancer created successfully."
echo "HTTP LB IP: $LB_IP"